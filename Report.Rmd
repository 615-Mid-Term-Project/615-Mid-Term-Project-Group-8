---
title: "PDF_REPORT BY GROUP 8"
author: "Group 8"
date: "11/1/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(magrittr)
library(dplyr)
library(plotrix)
library(wesanderson)
```

# Introduction
After wrangling data, we have the dataset from  only 4 states, which are California, Florida, Oregon and Washington. And we filtered the whole dataset by measured in pounds. By counting the observation grouped by State, we have a map plot, which showed in the California, there are more observations. 
```{r,message= FALSE, warning = FALSE}

source(file = "DataWrangling_and_Visualization.R", echo = FALSE)
freq_map()

```



# Exploratory data analysis
This barplot grouped by state shows the value of bee toxin levels, with years combined. 
We can see that we have most data observations in California.

```{r,message= FALSE, warning = FALSE}
plot_Cols(joined)
```

# Pie Plots

The pie plots show in different years and states the percentage of different levels of bee toxins.
it shows the variance of bee toxin. Can show difference in states and years.
Map with 4 states showing how much of the chemical is being used.

```{r,message= FALSE, warning = FALSE}
plot_Pies(joined)
```

# Scatter Plots

5 scatter plots show the splits amongst the measurement groups and 5 scatter plots that stratify state against bee toxin level

```{r,echo=FALSE,message=FALSE, warning=FALSE}
#Jack's point plot
plot_Points(joined)
```

# Bee Safe Program

In the mean time, we found out an article about the California State law named Bee safe program,
which related to bees and pesticides. https://lao.ca.gov/Publications/Report/3793

This State law requires that begin in 2018-2019, any person intending to apply any pesticide labeled “toxic to bees” to a blossoming plant to ask the local CAC, or designee, whether there are registered beekeepers with colonies located within a one-mile radius of the application site. The CAC provides the pesticide applicator with the contact information of registered beekeepers who wish to be notified in the affected areas.

Stacked Barplot showing percentage of use in terms of bee toxins based on the level over all 3 years.

```{r,echo=FALSE,message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)
library(dplyr)
## Load data and wrangling data

strawb <- read.csv("Strawberries.csv",fileEncoding = "latin1")

## Drop the no-info columns

drop_no_info_cols <- function(df){
  cnames = colnames(strawb)
  T = NULL
  for(i in 1:ncol(df)){
    T <- c(T, nrow(unique(df[i])))
    }
  drop_cols <- cnames[which(T == 1)]
  return(select(df, !all_of(drop_cols)))
}

strawb <- drop_no_info_cols(strawb)

## Divide "Data.Item" into 4 groups

strawb %<>% separate(col=Data.Item,
                     into = c("Strawberries", "items", "discription", "units"),
                     sep = ",",
                     fill = "right")

## Separate "Domain" into 2 columns

strawb %<>%  separate(col=Domain,
                      into = c("dname", "type" ), 
                      sep = ",", 
                      fill = "right")

## Make a copy of "Domain.Category", called "Chemicals"

strawb %<>% 
  mutate(Chemicals = Domain.Category) %>% 
  relocate(Chemicals, .after = Domain.Category) 

## Vector of logicals for each row with "CHEM" at the start of strawb$Chemicals
## Select "CHEM" from Chemicals"

bb <- strawb$Chemicals %>% str_detect("CHEM")

## Index 

ind_C <- (!bb)*(1:dim(strawb)[1])

## Drop "0" from "ind_C"

r1 <- ind_C[ind_C > 0]

## Set entries in Chemicals column to " " if they don't start with "CHEM"

strawb$Chemicals[r1] <- " "


## Now we need a list of chemicals
## Divide "Chemicals" into 2 groups

strawb %<>% separate(col = Chemicals,
                     into = c("title", "details"),
                     sep = ":",
                     fill = "right")

strawb %<>% mutate(details = str_extract(str_trim(details) ,"[^(].*[^)]") )
strawb %<>% mutate(type = str_trim(type))


strawb_chem <- strawb %>% filter((type=="FUNGICIDE")|
                                   (type=="HERBICIDE")|
                                   (type=="INSECTICIDE"))

strawb_other <- strawb %>% filter(type=="OTHER")

strawb_na <- strawb %>% filter(is.na(type)==TRUE)


pesticides <- read_csv("Pesticides(1).csv",show_col_types = FALSE)


#Delete "N/A" from "Pesticide"

pesticides <- filter(pesticides, !is.na(Pesticide))

#Delete "N/A" from "details"

strawb_new <- filter(strawb, !is.na(details))

## Divide "details" into 2 groups

strawb_new %<>% separate(col = details, 
                            into = c("chemical_name", "chemical_id"), 
                            sep = "=", 
                            fill = "right")

#Capitalization of the "Pesticide" so that it matches the the dataset "strawb"

pesticides <- mutate(pesticides, Pesticide = toupper(Pesticide))

#trimws: Deletes leading/trailing Spaces

strawb_new <- mutate(strawb_new, chemical_name = trimws(chemical_name))

## join two dataframe

joined <- inner_join(strawb_new, pesticides, 
                     by = c("chemical_name" = "Pesticide"))


## select column

joined_new<-select(joined,Year,State,discription,type,chemical_name,Value, Carcinogen,"Hormone Disruptor",Neurotoxins,"Developmental or Reproductive Toxins","Bee Toxins")


pesticides <- pesticides %>% 
  filter(!is.na(Pesticide))
pesticides <- pesticides %>% 
  mutate(Pesticide = toupper(Pesticide))
pesticides1 <- pesticides %>% 
  rename(chemical_name = Pesticide)

# deal with joined2
# install.packages("prob")
joined2 <- left_join(strawb_new, pesticides1,
                     by = "chemical_name")

# subset by state
california <- joined2 %>% 
  filter(State == "CALIFORNIA")
florida <- joined2 %>% 
  filter(State == "FLORIDA")
oregon <- joined2 %>% 
  filter(State == "OREGON")
washington <- joined2 %>% 
  filter(State == "WASHINGTON")

# subset by chemical type
cali_chem <- california %>% filter((type=="FUNGICIDE")|
                                   (type=="HERBICIDE")|
                                   (type=="INSECTICIDE"))
cali_other <- california %>% filter(type=="OTHER")

# subset by no chemical
cali_na <- california %>% filter(is.na(type)==TRUE)

# chemical data are classified according to year,unit of measurement,chemical type
cali_chem1 <- cali_chem %>% 
  group_by(Year, type, discription) %>% 
  summarise(count = n())

# value as.numeric
cali_chem$Value <- as.numeric(cali_chem$Value)

# sum
cali_chem1 <- cali_chem %>% 
  group_by(Year, type, discription) %>% 
  summarise(count = n(), value_sum = sum(Value))

# measured in lb larger than other units of measurement
aa <- !is.na(cali_chem$`Bee Toxins`)
ind_C1 <- (!aa)*(1:dim(cali_chem)[1])
r2 <- ind_C1[ind_C1>0]
cali_chem$`Bee Toxins`[r2] <- "none"

cali_chem_summary <- cali_chem %>% 
  group_by(Year,`Bee Toxins`) %>% 
  summarise(total_usage = sum(Value, na.rm = T))

# change position of slight,none
yy <- factor(as.factor(cali_chem_summary$`Bee Toxins`), levels = c("none", "slight" , "moderate", "high"))

cali_chem_summary$`Bee Toxins` <- yy

cali_chem_summary_ordered <- cali_chem_summary %>% 
  arrange(Year,`Bee Toxins`)

# total usage every year
cali_chem_summary1 <- cali_chem_summary %>% 
  group_by(Year) %>% 
  summarise(useageofyear = sum(total_usage))

# Bee toxicity of high, medium and low without use, percentage
perc_col = matrix(cbind(cali_chem_summary_ordered$total_usage[1:4] / 6046.092 , cali_chem_summary_ordered$total_usage[5:8] / 9177.122, cali_chem_summary_ordered$total_usage[9:12] / 8457.764), nrow = 12)

cali_chem_summary_ordered$percentage <- perc_col

#bar plot
ggplot(cali_chem_summary_ordered, aes(x = Year, y = percentage, fill = `Bee Toxins`)) +
  geom_col(position = "dodge")+ scale_fill_brewer(palette = "Pastel1")

#stacked plot
ggplot(cali_chem_summary_ordered, aes(fill = `Bee Toxins`, y = percentage, x = Year)) + 
  geom_bar(position="stack", stat="identity")+ scale_fill_brewer(palette = "Pastel2")

```

