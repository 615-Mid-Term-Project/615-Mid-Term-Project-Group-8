---
output: 
  revealjs::revealjs_presentation:
    theme: black
    highlight: pygments 
    css: reveal.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

<section data-background-opacity=0.2
         data-background-image="Strawberry-Bee.jpg">
   <h1 style="margin-top:35px;text-align:center;color=black;font-family:verdana;font-size:50px;">
Group 8: Bee Toxin Levels in Strawberry Chemicals</h1>

<p style="margin-top:475px;text-align:center;font-family:verdana;font-size:35px;color=black">Yujia Wang, Jack Carbaugh, Xiang Li, Danny Zhang</p>

#### image source --  https://ucanr.edu/blogs/blogcore/postdetail.cfm?postnum=4816

</section>

## Map of Distribution of Data

```{r, echo=FALSE, message= FALSE, warning = FALSE}
source(file = "PDF_REPORT.R", echo = FALSE)
freq_map()
```

## Measurement Exploration

```{r, echo=FALSE, out.width = "33%", message= FALSE, warning = FALSE}
source(file = "PDF_REPORT.R", echo = FALSE)
plot_Measurements(joined)
```

## Stratifying by State

```{r, echo=FALSE, out.width = "33%", out.height="50%", message= FALSE, warning = FALSE}
source(file = "PDF_REPORT.R", echo = FALSE)
plot_Points(joined)
plot_Cols(joined)
```

## Stratifying by State and Year

```{r, echo=FALSE, out.width = "50%", message= FALSE, warning = FALSE}
source(file = "PDF_REPORT.R", echo = FALSE)
plot_Pies(joined)
```

## Focus: Bee Safe Program
<p style="margin-top:175px;text-align:center;font-family:verdana;font-size:35px;color=black"> During the course of our EDA, we found an article about a recent law in California: the Bee Safe Program.  </p>
[Here is a link to the article](https://lao.ca.gov/Publications/Report/3793)

<p style="margin-top:175px;text-align:center;font-family:verdana;font-size:35px;color=black"> Beginning in 2018-2019, any person intending to use a pesticide labeled "toxic to bees" to a blossoming plant had to contact local beekeepers within 1 mile</p>


## The Effects of Bee Safe Program

```{r, echo=FALSE, message= FALSE, warning = FALSE}
library(tidyverse)
library(magrittr)
library(dplyr)
## Load data and wrangling data

strawb <- read.csv("Strawberries.csv",fileEncoding = "latin1")

## Drop the no-info columns

drop_no_info_cols <- function(df){
  cnames = colnames(strawb)
  T = NULL
  for(i in 1:ncol(df)){
    T <- c(T, nrow(unique(df[i])))
    }
  drop_cols <- cnames[which(T == 1)]
  return(select(df, !all_of(drop_cols)))
}

strawb <- drop_no_info_cols(strawb)

## Divide "Data.Item" into 4 groups

strawb %<>% separate(col=Data.Item,
                     into = c("Strawberries", "items", "discription", "units"),
                     sep = ",",
                     fill = "right")

## Separate "Domain" into 2 columns

strawb %<>%  separate(col=Domain,
                      into = c("dname", "type" ), 
                      sep = ",", 
                      fill = "right")

## Make a copy of "Domain.Category", called "Chemicals"

strawb %<>% 
  mutate(Chemicals = Domain.Category) %>% 
  relocate(Chemicals, .after = Domain.Category) 

## Vector of logicals for each row with "CHEM" at the start of strawb$Chemicals
## Select "CHEM" from Chemicals"

bb <- strawb$Chemicals %>% str_detect("CHEM")

## Index 

ind_C <- (!bb)*(1:dim(strawb)[1])

## Drop "0" from "ind_C"

r1 <- ind_C[ind_C > 0]

## Set entries in Chemicals column to " " if they don't start with "CHEM"

strawb$Chemicals[r1] <- " "


## Now we need a list of chemicals
## Divide "Chemicals" into 2 groups

strawb %<>% separate(col = Chemicals,
                     into = c("title", "details"),
                     sep = ":",
                     fill = "right")

strawb %<>% mutate(details = str_extract(str_trim(details) ,"[^(].*[^)]") )
strawb %<>% mutate(type = str_trim(type))


strawb_chem <- strawb %>% filter((type=="FUNGICIDE")|
                                   (type=="HERBICIDE")|
                                   (type=="INSECTICIDE"))

strawb_other <- strawb %>% filter(type=="OTHER")

strawb_na <- strawb %>% filter(is.na(type)==TRUE)


pesticides <- read_csv("Pesticides(1).csv",show_col_types = FALSE)


#Delete "N/A" from "Pesticide"

pesticides <- filter(pesticides, !is.na(Pesticide))

#Delete "N/A" from "details"

strawb_new <- filter(strawb, !is.na(details))

## Divide "details" into 2 groups

strawb_new %<>% separate(col = details, 
                            into = c("chemical_name", "chemical_id"), 
                            sep = "=", 
                            fill = "right")

#Capitalization of the "Pesticide" so that it matches the the dataset "strawb"

pesticides <- mutate(pesticides, Pesticide = toupper(Pesticide))

#trimws: Deletes leading/trailing Spaces

strawb_new <- mutate(strawb_new, chemical_name = trimws(chemical_name))

## join two dataframe

joined <- inner_join(strawb_new, pesticides, 
                     by = c("chemical_name" = "Pesticide"))


## select column

joined_new<-select(joined,Year,State,discription,type,chemical_name,Value, Carcinogen,"Hormone Disruptor",Neurotoxins,"Developmental or Reproductive Toxins","Bee Toxins")


pesticides <- pesticides %>% 
  filter(!is.na(Pesticide))
pesticides <- pesticides %>% 
  mutate(Pesticide = toupper(Pesticide))
pesticides1 <- pesticides %>% 
  rename(chemical_name = Pesticide)

# deal with joined2
# install.packages("prob")
joined2 <- left_join(strawb_new, pesticides1,
                     by = "chemical_name")

# subset by state
california <- joined2 %>% 
  filter(State == "CALIFORNIA")
florida <- joined2 %>% 
  filter(State == "FLORIDA")
oregon <- joined2 %>% 
  filter(State == "OREGON")
washington <- joined2 %>% 
  filter(State == "WASHINGTON")

# subset by chemical type
cali_chem <- california %>% filter((type=="FUNGICIDE")|
                                   (type=="HERBICIDE")|
                                   (type=="INSECTICIDE"))
cali_other <- california %>% filter(type=="OTHER")

# subset by no chemical
cali_na <- california %>% filter(is.na(type)==TRUE)

# chemical data are classified according to year,unit of measurement,chemical type
cali_chem1 <- cali_chem %>% 
  group_by(Year, type, discription) %>% 
  summarise(count = n())

# value as.numeric
cali_chem$Value <- as.numeric(cali_chem$Value)

# sum
cali_chem1 <- cali_chem %>% 
  group_by(Year, type, discription) %>% 
  summarise(count = n(), value_sum = sum(Value))

# measured in lb larger than other units of measurement
aa <- !is.na(cali_chem$`Bee Toxins`)
ind_C1 <- (!aa)*(1:dim(cali_chem)[1])
r2 <- ind_C1[ind_C1>0]
cali_chem$`Bee Toxins`[r2] <- "none"

cali_chem_summary <- cali_chem %>% 
  group_by(Year,`Bee Toxins`) %>% 
  summarise(total_usage = sum(Value, na.rm = T))

# change position of slight,none
yy <- factor(as.factor(cali_chem_summary$`Bee Toxins`), levels = c("none", "slight" , "moderate", "high"))

cali_chem_summary$`Bee Toxins` <- yy

cali_chem_summary_ordered <- cali_chem_summary %>% 
  arrange(Year,`Bee Toxins`)

# total usage every year
cali_chem_summary1 <- cali_chem_summary %>% 
  group_by(Year) %>% 
  summarise(useageofyear = sum(total_usage))

# Bee toxicity of high, medium and low without use, percentage
perc_col = matrix(cbind(cali_chem_summary_ordered$total_usage[1:4] / 6046.092 , cali_chem_summary_ordered$total_usage[5:8] / 9177.122, cali_chem_summary_ordered$total_usage[9:12] / 8457.764), nrow = 12)

cali_chem_summary_ordered$percentage <- perc_col

#bar plot
b1 <- ggplot(cali_chem_summary_ordered, aes(x = Year, y = percentage, fill = `Bee Toxins`)) +
  geom_col(position = "dodge")+ scale_fill_brewer(palette = "Pastel1")

ggplotly(b1)


```

## The Effects of Bee Safe Program
```{r, echo=FALSE, message= FALSE, warning = FALSE}
#stacked plot
b2 <- ggplot(cali_chem_summary_ordered, aes(fill = `Bee Toxins`, y = percentage, x = Year)) + 
  geom_bar(position="stack", stat="identity")+ scale_fill_brewer(palette = "Pastel2")

ggplotly(b2)
```


## Shiny App
<p style="margin-top:175px;text-align:center;font-family:verdana;font-size:35px;color=black"> Our Shiny app helps explore the changing Bee Toxin levels: </p>





